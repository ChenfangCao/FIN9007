---
title: "spxOptionCross"
author: "lbian01"
date: "09/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load lib

```{r lib, include=FALSE}
library(tidyverse)
library(tidyquant)
library(moments)
library(tseries)
library(bizdays)
```

#################################################################
### put call parity 
#################################################################

```{r ReadData}

spxOptionCross=read.csv("./sampleData/spxOptionData20200110.csv", #check.names=FALSE,
               colClasses=c("numeric","character","character",rep("numeric",3)))

```

```{r TransDate}

spxOptionCross$TradeDate <- 
  spxOptionCross$TradeDate %>% 
  as.Date("%Y%m%d")

spxOptionCross$expiryDate <- 
  spxOptionCross$expiryDate %>% 
  as.Date("%Y%m%d")

```


```{r sort&newData}
#spxOptionCross %<>%   arrange(expiryDate)

sort(unique(spxOptionCross$expiryDate))

selectedExpiry <- "2020-06-19"#select from sort?

oneExpiryOptionData <- 
  spxOptionCross %>% 
  filter(expiryDate==selectedExpiry)

```


# calculate business days

```{r calBusiDays}

business_calendar <- 
  create.calendar('my_calendar', 
                  weekdays = c('saturday','sunday'))

ttm=bizdays(oneExpiryOptionData$TradeDate[1],
            oneExpiryOptionData$expiryDate[1], 
            cal = business_calendar)/252

```



```{r cal&Sort Data}

callOptionData <- filter(oneExpiryOptionData,c_p==1)

CallOptionData <- CallOptionData %>% 
  arrange(strike)
#Put Option
putOptionData <- filter(oneExpiryOptionData,c_p==0)

putOptionData <- putOptionData %>% 
  arrange(strike)

```



```{r group&Plot}

group <- ifelse(oneExpiryOptionData$c_p==1, "Call options", "Put options")

oneExpiryOptionData %>% 
  ggplot(aes(x=strike,y=price,color=group))+
  geom_point()

```


# pair call and put

```{r pair}

pairedOptions <- 
  oneExpiryOptionData %>% 
  distinct(strike) %>% 
  arrange(strike) %>% 
  data.frame() %>%
  left_join(callOptionData[,c('strike','price')],by="strike")# merge by strike

```


colnames(pairedOptions)[colnames(pairedOptions)=='price'] <- "callPrice"
pairedOptions=merge(x=pairedOptions,y=putOptionData[,c('strike','price')],by="strike",all.x=TRUE)
colnames(pairedOptions)[colnames(pairedOptions)=='price'] <- "putPrice"

pairedOptions$impliedSPX_Pseudo=pairedOptions$callPrice+pairedOptions$strike-pairedOptions$putPrice
plot(pairedOptions$strike,pairedOptions$impliedSPX_Pseudo)

# implied futures, interest rate
sampleImpliedR=data.frame(strike=pairedOptions$strike,x=(pairedOptions$putPrice-pairedOptions$callPrice))
resIR=lm(strike ~ x, data = sampleImpliedR)
impliedSPXF=resIR$coefficients[1]
impliedR=log(resIR$coefficients[2])/ttm


pairedOptions$impliedSPXF=pairedOptions$callPrice*exp(impliedR*ttm)+pairedOptions$strike-pairedOptions$putPrice*exp(impliedR*ttm)
plot(pairedOptions$strike,pairedOptions$impliedSPXF)

# get the corresponding index level
underlying <- read.csv("./sampleData/underlyingSampleData.csv", header=T,as.is = T)
underlying$TradeDate=as.Date(underlying$TradeDate, format = "%Y-%m-%d")
spotUndelrying=underlying[underlying$TradeDate=="2020-01-10",'SPX']

# get the corresponding futures price
spEminiCross=read.csv("./sampleData/spxEminiTrade20200110.csv", header=T,as.is = T,check.names=FALSE)
spEminiCross$TradeDate=as.Date(spEminiCross$TradeDate, format = "%d/%m/%Y")
spotSPEmini=spEminiCross[1,'19/06/2020']

# implied dividend yield
impliedDividend=impliedR-log(impliedSPXF/spotUndelrying)/ttm

# implied index level
pairedOptions$impliedSPX=(pairedOptions$callPrice+pairedOptions$strike*exp(-impliedR*ttm)-pairedOptions$putPrice)*exp(impliedDividend*ttm)

plot(pairedOptions$strike,pairedOptions$impliedSPX)
impliedSPX=mean(pairedOptions$impliedSPX)
#################################################################


#################################################################
### Option bounds
#################################################################
#call options
callOptionData$upperBound=spotUndelrying
callOptionData$lowerBound=impliedSPX*exp(-impliedDividend*ttm)-callOptionData$strike*exp(-impliedR*ttm)
callOptionData$lowerBound[callOptionData$lowerBound<0]=0


plot(callOptionData$strike,callOptionData$price, cex = 0.5,ylim=c(0,spotUndelrying*1.2))
lines(callOptionData$strike,callOptionData$upperBound,col="green")
lines(callOptionData$strike,callOptionData$lowerBound,col="red")

#put option
putOptionData$upperBound=putOptionData$strike*exp(-impliedR*ttm)
putOptionData$lowerBound=putOptionData$strike*exp(-impliedR*ttm)-spotUndelrying*exp(-impliedDividend*ttm)
putOptionData$lowerBound[putOptionData$lowerBound<0]=0

plot(putOptionData$strike,putOptionData$price, cex = 0.5,ylim=c(0,spotUndelrying*1.2))
lines(putOptionData$strike,putOptionData$upperBound,col="green")
lines(putOptionData$strike,putOptionData$lowerBound,col="red")
#################################################################
