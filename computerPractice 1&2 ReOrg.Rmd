---
title: "Exercise 1&2 ReOrg"
author: "lbian01"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###### See here for [Dataset Explanation]

```{r lib, include=FALSE}
library(tidyverse)
library(tidyquant)
library(moments)
library(tseries)
library(bizdays)
library(magrittr)
```

```{r load all data, include=FALSE}

# read underlying SP500 and SPDR data
underlying <- 
  read.csv("./sampleData/underlyingSampleData.csv", header=T,as.is = T)

# as date
  underlying$TradeDate %<>%
  as.Date("%Y-%m-%d")

# read the SPX cross section data on 20200110 
spxOptionCross <-
  read.csv("./sampleData/spxOptionData20200110.csv", #check.names=FALSE,
               colClasses=c("numeric","character","character",rep("numeric",3)))

# as date SPX
spxOptionCross$TradeDate %<>% 
  as.Date("%Y%m%d")
spxOptionCross$expiryDate %<>% 
  as.Date("%Y%m%d")

# read the SPX Panel data on 20200110 
spxOptionPD <- 
  read.csv("./sampleData/spxOptionDataEx20200619.csv", colClasses=c("numeric","character","character",rep("numeric",3)))

# as date SPXEx
spxOptionPD$TradeDate %<>%
  as.Date("%Y%m%d")
spxOptionPD$expiryDate %<>% 
  as.Date("%Y%m%d")

# read the SPY data 
spyOptionCross <- 
  read.csv("./sampleData/spyOptionData20200110.csv", colClasses=c("numeric","character","character",rep("numeric",3)))

# as date SPY
spyOptionCross$TradeDate %<>%
  as.Date("%Y%m%d")
spyOptionCross$expiryDate %<>% 
  as.Date("%Y%m%d")

# read the SPYEx data 
spyOptionPD <- 
  read.csv("./sampleData/spyOptionDataEx20200619.csv", colClasses=c("numeric","character","character",rep("numeric",3)))

# as date SPYEx
spyOptionPD$TradeDate %<>%
  as.Date("%Y%m%d")
spyOptionPD$expiryDate %<>% 
  as.Date("%Y%m%d")

# read spx EminiEx data
spEminiTS <- 
  read.csv("./sampleData/spxEminiEx20200619.csv", header=T,as.is = T,check.names=FALSE)

# as date
spEminiTS$TradeDate %<>% 
  as.Date("%d/%m/%Y")

```

#### *1.1 Present and comment on the summary statistics of S&P 500 index, SDPR ETF, S&P 500 E-mini futures, SPX options, and SPY options. (5%)*

###### 1.1.1 S&P 500 index, SDPR ETF (SPY)

```{r 1.1.1 Read Underlying, eval=FALSE, include=FALSE}

underlying <- read.csv("./sampleData/underlyingSampleData.csv", header=T,as.is = T)

underlying$TradeDate <- 
  underlying$TradeDate %>%
  as.Date("%Y-%m-%d")



```

```{r 1.1.1 Return Calcu}

Nspx <- length(underlying$SPX)

underlying <- underlying %>% 
  mutate(retSPX=c(NA,SPX[2:Nspx]/SPX[1:Nspx-1]-1),
         retSPY=c(NA,SPY[2:Nspx]/SPY[1:Nspx-1]-1),
         logRetSPX=c(NA,diff(log(SPX))),
         logRetSPY=c(NA,diff(log(SPY))),
         ) %>% 
  na.omit()

```

```{r 1.1.1 set Dates }
# Set the begin date and end date 
# why select?

B.dates <- "2010-01-01"
E.dates <- "2020-12-31"

```

```{r 1.1.1 filter with set Dates}

selectedUnderlying <- filter(underlying,TradeDate>=B.dates&TradeDate<=E.dates )
  
```

Summary of SPX log return

```{r 1.1.1 plot SPX}

selectedUnderlying %>% 
  ggplot(aes(x=TradeDate,y=SPX))+
  geom_line(colour="red")

```

```{r 1.1.1 SPX summary }
mean(selectedUnderlying$logRetSPX)*252
var(selectedUnderlying$logRetSPX)
sqrt(var(selectedUnderlying$logRetSPX)*252)
skewness(selectedUnderlying$logRetSPX)
kurtosis(selectedUnderlying$logRetSPX)

# normality test
jarque.bera.test(selectedUnderlying$logRetSPX)
```


```{r 1..1.1 SPX hist plot}
hist(selectedUnderlying$logRetSPX, breaks = 100)
d <- density(selectedUnderlying$logRetSPX)
d
plot(d)
```

```{r 1.1.1 SPX density and N-Distribut}
# compare empirical density and a normal distribution with the same mean and variance

xAxis=seq(-0.15,0.1,by=0.0001)
plot(d,xlim = c(-0.05,0.05))
lines(xAxis,dnorm(xAxis, mean(selectedUnderlying$logRetSPX), sqrt(var(selectedUnderlying$logRetSPX))),col="green")

```


###### 1.1.2 Summary of SPY log return
```{r 1.1.2 plot SPY}

selectedUnderlying %>% 
  ggplot(aes(x=TradeDate,y=SPY))+
  geom_line(colour="red")

```

```{r 1.1.2 SPY summary }

mean(selectedUnderlying$logRetSPY)*252
var(selectedUnderlying$logRetSPY)
sqrt(var(selectedUnderlying$logRetSPY)*252)
skewness(selectedUnderlying$logRetSPY)
kurtosis(selectedUnderlying$logRetSPY)

# normality test
jarque.bera.test(selectedUnderlying$logRetSPY)

```

```{r 1.1.2 SPY density and N-Distribut}
# compare empirical density and a normal distribution with the same mean and variance

xAxis=seq(-0.15,0.1,by=0.0001)
plot(d,xlim = c(-0.05,0.05))
lines(xAxis,dnorm(xAxis, mean(selectedUnderlying$logRetSPX), sqrt(var(selectedUnderlying$logRetSPX))),col="green")

```


######1.1.3 Summary of SPX option (log return?)

```{r 1.1.3 SPXOption Return Calcu}

NspxOpt <- length(underlying$SPX)

underlying <- underlying %>% 
  mutate(retSPX=c(NA,SPX[2:NspxOpt]/SPX[1:NspxOpt-1]-1),
         logRetSPX=c(NA,diff(log(SPX)))
         ) %>% 
  na.omit()

```

#### *1.2 Present and comment on the relationship between S&P 500 index and SDPR ETF. (5%)*

```{r 1.2 plot spx-spy}

selectedUnderlying %>% 
  ggplot()+
  geom_line(aes(x=TradeDate,y=SPX),colour="red")+
  geom_line(aes(x=TradeDate,y=SPY*10),colour="green")

```

```{r 1.2 plot spx-spy10}
#according to above plot, spx is quiet close to spy*10.  try plot out the diff and %diff
selectedUnderlying <- selectedUnderlying %>% 
  mutate(diff=SPX-SPY*10) 

selectedUnderlying %>%
  ggplot(aes(x=TradeDate,y=diff))+
  geom_line(colour="red")
```

```{r 1.2 plot diffP}

selectedUnderlying <-
  selectedUnderlying %>% 
  mutate(diffP=(SPX/SPY*10)-1) 

selectedUnderlying %>%
  ggplot(aes(x=TradeDate,y=diffP))+
  geom_line(colour="red")

```



line 65


#### *1.3 Use time series of S&P 500 futures prices, present and comment the relationship between S&P 500 futures and S&P 500 index level. (5%)*

```{r 1.3 ReadData, eval=FALSE, include=FALSE}
spEminiTS=read.csv("./sampleData/spxEminiEx20200619.csv", header=T,as.is = T,check.names=FALSE)

spEminiTS$TradeDate %<>% 
  as.Date("%d/%m/%Y")

```

```{r 1.3 Merge}
#merge SPX to TS by Date

spEminiTS=merge(x=spEminiTS,y=underlying[c('TradeDate','SPX')],by="TradeDate",all.x=TRUE)

```

```{r 1.3 mutate new Basis cols}
spEminiTS <- 
  spEminiTS %>% 
  mutate(Basis=spEminiTS$`19/06/2020`-SPX,
         BasisP=SPX/spEminiTS$`19/06/2020`-1)

```

```{r 1.3 plot Basis and Basisp}
spEminiTS %>% 
  ggplot(aes(x=TradeDate,y=Basis))+
  geom_line(colour="red")

spEminiTS %>% 
  ggplot(aes(x=TradeDate,y=BasisP))+
  geom_line()


```

line 96


#### *2.1 Estimate the put-call parity implied underlying asset price. Compare the put-call parity implied underlying asset price with the S&P 500 index level and S&P 500 futures price. Calculate put-call parity implied interest rate and dividend yield. Does put-call parity implied underlying asset price always move in the same direction as the S&P 500 index level? (15%)*

```{r 2.1 reload spxOption, eval=FALSE, include=FALSE}

spxOptionCross=read.csv("./sampleData/spxOptionData20200110.csv", #check.names=FALSE,
               colClasses=c("numeric","character","character",rep("numeric",3)))

```

```{r 2.1 TransDate, eval=FALSE, include=FALSE}

spxOptionCross$TradeDate %<>% 
  as.Date("%Y%m%d")

spxOptionCross$expiryDate %<>% 
  as.Date("%Y%m%d")

```

```{r 2.1 sort&newData}
#spxOptionCross %<>%   arrange(expiryDate)

sort(unique(spxOptionCross$expiryDate))

selectedExpiry <- "2020-06-19"#select from sort?

oneExpiryOptionData <- 
  spxOptionCross %>% 
  filter(expiryDate==selectedExpiry)

```

###### calculate business days

```{r 2.1 calBusiDays}

business_calendar <- 
  create.calendar('my_calendar', 
                  weekdays = c('saturday','sunday'))

ttm=bizdays(oneExpiryOptionData$TradeDate[1],
            oneExpiryOptionData$expiryDate[1], 
            cal = business_calendar)/252

```

```{r 2.1 cal&Sort Data}
#Call Option
callOptionData <- filter(oneExpiryOptionData,c_p==1)

callOptionData <- callOptionData %>% 
  arrange(strike)

#Put Option
putOptionData <- filter(oneExpiryOptionData,c_p==0)

putOptionData <- putOptionData %>% 
  arrange(strike)

```

```{r 2.1 group&Plot}

group <- ifelse(oneExpiryOptionData$c_p==1, "Call options", "Put options")

oneExpiryOptionData %>% 
  ggplot(aes(x=strike,y=price,color=group))+
  geom_point()

```

###### pair call and put

```{r 2.1 pair}

pairedOptions <- 
  oneExpiryOptionData %>% 
  distinct(strike) %>% 
  arrange(strike) %>% 
  data.frame() %>%
  left_join(callOptionData[,c('strike','price')],by="strike")# merge by strike

```

```{r 2.1 rename&merge}

pairedOptions <-
  pairedOptions %>% 
  rename(callPrice=price) %>% 
  left_join(putOptionData[,c('strike','price')],by="strike") %>% 
  rename(putPrice=price)

```

```{r 2.1 implied&Plot}

pairedOptions %<>% 
  mutate(impliedSPX_Pseudo=callPrice+strike-putPrice)
#plot
ggplot(pairedOptions,aes(x=strike,y=impliedSPX_Pseudo))+
  geom_point(shape = 1)

```

###### implied futures, interest rate

```{r 2.1 sample & regress}

sampleImpliedR <- 
  pairedOptions %>% 
  mutate(x=putPrice-callPrice) %>% 
  select(strike,x) %>% 
  data.frame()

#linear regression
resIR=lm(strike ~ x, data = sampleImpliedR)

impliedSPXF=resIR$coefficients[1]

impliedR=log(resIR$coefficients[2])/ttm

```

```{r 2.1 impliedSPXF&plot}

pairedOptions <- pairedOptions %>% 
  mutate(impliedSPXF=(callPrice-putPrice)*exp(impliedR*ttm)+strike)
#
ggplot(pairedOptions,aes(x=strike,y=impliedSPXF))+
  geom_point()


```

#### get the corresponding index level

```{r 2.1 spotUnderlying}

underlying <- read.csv("./sampleData/underlyingSampleData.csv", header=T,as.is = T)

underlying$TradeDate %<>% 
  as.Date("%Y-%m-%d")

spotUnderlying <- underlying[underlying$TradeDate=="2020-01-10",'SPX']

```

###### get the corresponding futures price

```{r 2.1 load futures price}

spEminiCross <- read.csv("./sampleData/spxEminiTrade20200110.csv", header=T,as.is = T,check.names=FALSE)

spEminiCross$TradeDate %<>% as.Date("%d/%m/%Y")

spotSPEmini <- spEminiCross[1,'19/06/2020']

```

###### implied dividend yield

```{r 2.1 dividend yield}

impliedDividend <- impliedR-log(impliedSPXF/spotUnderlying)/ttm
```

###### implied index level

```{r 2.1 index level}

pairedOptions <- 
  pairedOptions %>% 
  mutate(impliedSPX=
           (callPrice-putPrice+strike*exp(-impliedR*ttm))
         *exp(impliedDividend*ttm)
         )
#Plot
ggplot(pairedOptions,aes(x=strike,y=impliedSPX))+
  geom_point(shape=1)

impliedSPX <- mean(pairedOptions$impliedSPX)
```


#### *2.2 Compare option price bounds and the market option prices. Does option prices within the theoretical bounds? Is there an arbitrage opportunity? (5%)*


##### call options

```{r 2.2 mutate Call Bounds}

callOptionData <- 
  callOptionData %>% 
  mutate(upperBound=spotUnderlying,
         lowerBound=impliedSPX*exp(-impliedDividend*ttm)-strike*exp(-impliedR*ttm))

callOptionData$lowerBound[callOptionData$lowerBound<0]=0

```

```{r 2.2 Plot Call Bounds}
callOptionData %>% 
  ggplot(aes(x=strike))+
  ylim(0,spotUnderlying*1.2)+
  geom_point(aes(y=price),shape=1)+
  geom_line(aes(y=upperBound,colour="upperBound"))+
  geom_line(aes(y=lowerBound,colour="lowerBound"))
```

##### put option

```{r 2.2 mutate put Bounds}
putOptionData <- 
  putOptionData %>% 
  mutate(upperBound=strike*exp(-impliedR*ttm),
         lowerBound=strike*exp(-impliedR*ttm)-spotUnderlying*exp(-impliedDividend*ttm))

putOptionData$lowerBound[putOptionData$lowerBound<0]=0
```

```{r 2.2 Plot Put Bounds}
putOptionData %>% 
  ggplot(aes(x=strike))+
  ylim(0,spotUnderlying*1.2)+
  geom_point(aes(y=price),shape=1)+
  geom_line(aes(y=upperBound,colour="upperBound"))+
  geom_line(aes(y=lowerBound,colour="lowerBound"))

```

#### *3.1 Use binomial tree model, calculate both SPX and SPY option prices. Are option prices calculated from the binomial tree model consistent with market option prices? (10%)*





#### Dataset Explanation

> *Underlying* = S&P500 + SDPR ETF (SPY column) trade from `r min(underlying$TradeDate)` to `r max(underlying$TradeDate)` expiry from `r min(underlying$expiryDate)` to `r max(underlying$expiryDate)`

> *SPX option* trade at 2020-01-10 expiry from `r min(spxOptionCross$expiryDate)` to `r max(spxOptionCross$expiryDate)`

> *And expiry* at 2020-06-19 trade from `r min(spxOptionPD$TradeDate)` to `r max(spxOptionPD$TradeDate)`

> *SPY option* trade at 2020-01-10 expiry from `r min(spyOptionCross$expiryDate)` to `r max(spyOptionCross$expiryDate)`

> *And expiry* at 2020-06-19 trade from `r min(spyOptionPD$TradeDate)` to `r max(spyOptionPD$TradeDate)`

> *SPX mini futures* trade at 2020-01-10

> *And expiry* at 2020-06-19 trade from `r min(spEminiTS$TradeDate)`to `r max(spEminiTS$TradeDate)`
